<h2><%=h @match.name %></h2>
<% if @match.complete? %>
  <h3>This match is over.</h3>
<% elsif current_user == @match.admin %>
  <%= link_to "Close this match", complete_match_path(@match), :method => :put %>
<% end %>
<p>
  <b>Admin:</b> <%= link_to h(@match.admin.fullname), @match.admin %>
</p>

<p>
  <b>Github:</b> <%= link_to h(@match.github_url), h(@match.github_url) %>
</p>

<p>
  <b>Description:</b>
  <%=h @match.description %>
</p>

<h3>Players:</h3>
<%- if @match.players.any? -%>
<ul>
  <%- for user in @match.players.map(&:user) -%>
  <li><%= link_to(h(user.fullname), user) %></li>
  <%- end -%>
</ul>
<%- else -%>
<p>No players yet for this match. Browse to a user's profile to add them to
your available matches.</p>
<%- end -%>

<h3>Current Volley</h3>
<%- if @match.volleys.incomplete.any? -%>
<ul>
<%- for volley in @match.volleys.incomplete -%>
  <li>
    <%- if !volley.commits.blank? -%>
    <%= link_to h(volley.player.user.fullname), volley.player.user %>
    <ul>
      <%- for commit in volley.commits -%>
      <li>
        <%= link_to h(commit.guid), h(commit.url) %>
        <%= link_to h(commit.player.user.fullname), commit.player.user.github_url %>
        <%= link_to h(commit.message), h(commit.url) %>
      </li>
      <%- end -%>
    </ul>
    <%- else -%>
    <%= link_to h(volley.player.user.fullname), volley.player.user %> hasn't made any commits yet.
    <%- end -%>
  </li>
<%- end -%>
</ul>
<%- if current_user == @match.admin -%>
	<%= link_to "End current volley", volley_match_path(@match), :method => :put  %>
<%- end -%>
<%- end -%>

<h3>Complete Volleys</h3>
<%- if @match.volleys.complete.any? -%>
  <ul>
  <%- for volley in @match.volleys.complete -%>
    <li>
      <%- if !volley.commits.blank? -%>
      <%= link_to h(volley.player.user.fullname), volley.player.user %>
      <ul>
        <%- for commit in volley.commits -%>
        <li>
          <%= link_to h(commit.guid), h(commit.url) %>
          <%= link_to h(commit.player.user.fullname), commit.player.user.github_url %>
          <%= link_to h(commit.message), h(commit.url) %>
        </li>
        <%- end -%>
      </ul>
      <%- else -%>
      <%= link_to h(volley.player.user.fullname), volley.player.user %> hasn't made any commits yet.
      <%- end -%>
    </li>
  <%- end -%>
  </ul>

<div id="volley-timeline" class="timeline" style="height: 150px; border: 1px solid #aaa"></div>

<%- else -%>
<p>No volleys have been completed.</p>
<%- end -%>


<p>
  <%= link_to "Back", matches_path %>
  <% if @match.admin == current_user %>| <%= link_to "Edit", edit_match_path(@match) %><% end %>
</p>


<div id="match_id" style="display:none;"><%= @match.id %></div>
<script type="text/javascript" charset="utf-8">
var tl;
var resizeTimerID = null;
var match_id = document.getElementById('match_id').innerHTML;
function onLoad() {
  var eventSource = new Timeline.DefaultEventSource();
	  var bandInfos = [
	    Timeline.createBandInfo({
		  	eventSource:    eventSource,
		  	//0date:           "Jun 28 2006 00:00:00 GMT",
			width:          "70%", 
	        intervalUnit:   Timeline.DateTime.MONTH, 
	        intervalPixels: 100
	    }),
	    Timeline.createBandInfo({
	      	eventSource:    eventSource,
	       	//date:           "Jun 28 2006 00:00:00 GMT",
	    	width:          "30%", 
	        intervalUnit:   Timeline.DateTime.YEAR, 
	        intervalPixels: 200
	    })
	  ];
	 bandInfos[1].syncWith = 0;
	  bandInfos[1].highlight = true;
	  tl = Timeline.create(document.getElementById('volley-timeline'), bandInfos);
	 Timeline.loadXML("http://localhost:3000/matches/" + match_id + "/volleys.xml" , function(xml, url) { eventSource.loadXML(xml, url); });
	};

function onResize() {
	    if (resizeTimerID == null) {
	        resizeTimerID = window.setTimeout(function() {
	            resizeTimerID = null;
	            tl.layout();
	        }, 500);
	    }
};

</script>